---
title: "Audio Dashboard - Million Song Dataset"
author: Tiago Teixeira, Jaime Rodrigues
format:
    dashboard:
        orientation: columns
        scrolling: true
        expandable: false
        theme: dark
---
<link rel="stylesheet" href="assets/css/main.css">
<script src="https://d3js.org/d3.v7.min.js"></script>

```{ojs}
//| output: false
dataHigh = FileAttachment("data/high_popularity_spotify_data.json").json()
dataLow = FileAttachment("data/low_popularity_spotify_data.json").json()

all_music = {
    const combined = [
        ...dataHigh.map(d => ({...d, category: "High"})),
        ...dataLow.map(d => ({...d, category: "Low"}))
    ];
    return Array.from(new Map(combined.map(item => [item.track_id, item])).values());
}
```

## Coluna 1 {width=60%}

###  Filtros {.toolbar}

``` {ojs}
viewof search = Inputs.search(all_music, {label: "Procurar música ou artista:"})
```

### Estatísticas da Biblioteca

``` {ojs}
//| component: valuebox
//| title: "Total de Músicas"
//| color: "#0be7d5"
//| icon: music-note-beamed
all_music.length
```

```{ojs}
//| component: valuebox
//| title: "Géneros Musicais"
//| color: "#0be7d5"
//| icon: tags
new Set(all_music.map(d => d.playlist_genre)).size
```

```{ojs}
//| component: valuebox
//| title: "Popularidade Média"
//| color: "#0be7d5"
//| icon: graph-up-arrow

{
    const media = d3.mean(all_music, d => d.track_popularity);
    return html`<h3>${media.toFixed(1)}%</h3>`;
}

```

### Lista de musicas

``` {ojs}

viewof selectedTrack = Inputs.table(search, {
    columns: ["track_name", "track_artist", "playlist_genre", "track_popularity"],
    header: {
        track_name: "Música",
        track_artist: "Artista",
        playlist_genre: "Género",
        track_popularity: "Popularidade"
    },
    format: {
        track_popularity: p => html`<div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: ${p}px; max-width: 100px; height: 8px; background: ${p > 70 ? '#0be7d5' : '#ffd700'}; border-radius: 4px;"></div>
            <span>${p}%</span>
        </div>`
    },
    layout: "fixed",
    rows: 15,
    multiple: false,
})

currentTrack = selectedTrack || search[0] || all_music[0]

```

## Coluna2 {width=40%}

### Perfil de Áudio {height=33%}

``` {ojs}

radarData = [
    {axis: "Energy", value: currentTrack.energy },
    {axis: "Dance", value: currentTrack.danceability },
    {axis: "Acoustic", value: currentTrack.acousticness },
    {axis: "Valence", value: currentTrack.valence },
    {axis: "Speech", value: currentTrack.speechiness }
];
{
    const width = 300;
    const height = 300;
    const margin = 50; 
    const radius = Math.min(width, height) / 2 - margin;
    const svg = d3.create("svg")
        .attr("viewBox", [0, 0, width, height])
        .style("overflow", "visible");

    const g = svg.append("g")
        .attr("transform", `translate(${width/2},${height/2})`);

    const angleSlice = (Math.PI * 2) / radarData.length;
    const rScale = d3.scaleLinear().domain([0, 1]).range([0, radius]);

    const axis = g.selectAll(".axis")
        .data(radarData)
        .enter().append("g");

    axis.append("line")
        .attr("x1", 0)
        .attr("y1", 0)
        .attr("x2", (d, i) => rScale(1) * Math.cos(angleSlice * i - Math.PI/2))
        .attr("y2", (d, i) => rScale(1) * Math.sin(angleSlice * i - Math.PI/2))
        .style("stroke", "#999")
        .style("stroke-width", "1px");

    axis.append("text")
        .attr("x", (d, i) => rScale(1.25) * Math.cos(angleSlice * i - Math.PI/2))
        .attr("y", (d, i) => rScale(1.25) * Math.sin(angleSlice * i - Math.PI/2))
        .text(d => d.axis)
        .style("font-family", "sans-serif")
        .style("font-size", "16px") 
        .style("font-weight", "bold")
        .style("fill", "#0be7d5") 
        .attr("text-anchor", "middle")
        .attr("dy", "0.35em");

    g.selectAll(".grid-circle")
        .data([0.2, 0.4, 0.6, 0.8, 1])
        .enter().append("circle")
        .attr("r", d => rScale(d))
        .style("fill", "none")
        .style("stroke", "#444")
        .style("stroke-dasharray", "4,4");

    // 5. Desenhr o polígono (Área preenchida)

    const radarLine = d3.lineRadial()
        .curve(d3.curveLinearClosed)
        .radius(d => rScale(d.value))
        .angle((d, i) => i * angleSlice);

    g.append("path")
        .datum(radarData)
        .attr("d", radarLine)
        .style("fill", currentTrack.category === "High" ? "#0be7d5" : "#ff4d4d")
        .style("fill-opacity", 0.5)
        .style("stroke", "white")
        .style("stroke-width", "2px");
    return svg.node();
}

```

### Comparativo de Energia {height=33%}

```{ojs}

{
  const genreAvgEnergy = d3.mean(all_music.filter(d => d.playlist_genre === currentTrack.playlist_genre), d => d.energy);

  return Plot.plot({
    title: html`<div style="font-size: 14px; margin-bottom: 10px; color: white;">
                  Energia: <b>${currentTrack.track_name}</b> vs Média de <b>${currentTrack.playlist_genre}</b>
                </div>`,
    height: 120,
    marginLeft: 20,
    marginRight: 20,
    x: { domain: [0, 1], label: "Nível de Energia →", grid: true },
    marks: [
      // Barra de fundo que representa a média do género
      Plot.barX([genreAvgEnergy], {
        x: genreAvgEnergy,
        fill: "#333",
        fillOpacity: 0.8,
        insetTop: 20,
        insetBottom: 20
      }),

      // Linha vertical branca no ponto exato da média

      Plot.ruleX([genreAvgEnergy], {stroke: "white", strokeWidth: 2.5}),

      // O ponto (dot) que representa a música atual

      Plot.dot([currentTrack.energy], {
          x: d => d,
          fill: currentTrack.energy > genreAvgEnergy ? "#0be7d5" : "#ff4d4d",
          r: 8,
          stroke: "white",
          strokeWidth: 2
      }),
      // Textos explicativos

      Plot.text([`Média`], {x: genreAvgEnergy, dy: -40, fill: "#888", fontSize: 11}),
      Plot.text([`Música`], {x: currentTrack.energy, dy: 40, fill: "white", fontWeight: "bold", fontSize: 12})
    ],
    style: {
      background: "transparent",
      color: "#ccc",
      fontFamily: "sans-serif",
      overflow: "visible" // Garante que as labels fora do eixo aparecem
    }
  });
}
```

### Reprodução e Análise {height=33%}

```{ojs}

html`<iframe
    src=${"https://open.spotify.com/embed/track/" + (selectedTrack?.track_id || all_music[0].track_id)}
    width="100%" height="152"
    frameborder="0"
    allowtransparency="true"
    allow="encrypted-media"></iframe>`
{
    let ctx, analyser, dataArray, bufferLength, animationId;
    const audioPath = `assets/audio/${currentTrack.track_id}.mp3`
    const canvas = html`<canvas width="400" height="100" style="width:100%; background:#1a1a1a; border-radius:8px;"></canvas>`;
    const canvasCtx = canvas.getContext("2d");
    const audio = html`<audio controls src="${audioPath}" style="width:100%; margin-top:10px;"></audio>`;

    function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);

        canvasCtx.fillStyle = "#1a1a1a";
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = "#0be7d5";
        canvasCtx.beginPath();

        const sliceWidth = canvas.width / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
        const v = dataArray[i] / 128.0;
        const y = (v * canvas.height) / 2;

        if (i === 0) canvasCtx.moveTo(x, y);
        else canvasCtx.lineTo(x, y);

        x += sliceWidth;
        }

        canvasCtx.stroke();
    }

    audio.onplay = () => {
        if (!ctx) {
            ctx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = ctx.createAnalyser();
            const source = ctx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(ctx.destination);
            analyser.fftSize = 1024;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            draw();
        }
    };

    return html`
        <div style="padding:15px; background:#222; border-radius:12px; border:1px solid #333;">
            <h6 style="margin:0; color:#888; font-size:0.7em; text-transform:uppercase;">Análise de Áudio Local</h6>
            <div style="font-weight:bold; color:white; margin-bottom:5px;">${currentTrack.track_name}</div>
            ${audio}
            ${canvas}
            <div>
                <span style="color:#aaa;">Ficheiro: ${currentTrack.track_id}.mp3</span>
            </div>
        </div>
    `;
}

```